<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Sticky Note Magic with tracking.js</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- TRACKING LIBRARY -->
    <script src="tracking.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <!-- OCR LIBRARY JS -->
    <!-- function is commented below  -->
    <!-- <script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script> -->

    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: Helvetica, Arial, sans-serif;
        }



        .demo-container {

            /*width: 4476px;
            height: 2972px;*/
            position: relative;
            background: #eee;
            overflow: hidden;
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
        }

        .dg.ac {
            z-index: 100 !important;
            top: 50px !important;
        }

        .rect {
            width: 80px;
            height: 80px;
            position: absolute;
            left: -1000px;
            top: -1000px;
        }

        .col-md-3 {
            margin: 30px 30px;
        }
        .nav{
          height:150px;

        }

        .navbar-brand{
          font-size: 100px;
        }
        .navbar{
          padding:50px;
        }

        #colorChoice{
          width:150px;
          height:75px;
        }

    </style>

</head>
<body>
  <nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Sticky Note Magic</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
       <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
         <form class="navbar-form navbar-left">
           <div class="form-group">
                <div class="input-group">
                  <input type='file' name="file" id="file" class="inputfile" accept='image/*' onchange='openFile(event)'/>
                  <span class="input-group-addon" id="spanny" >Register Custom Color</span>
                  <input type="text" class="form-control" id="colorNumber" placeholder="colorname" aria-describedby="spanny">
                </div>
                  <!-- <input type='text' id='colorNumber' /> -->
                <div class="input-group">
                  <input type="color" id="colorChoice"  onchange='registerCustomColor()'  value="#ff0000" />



                </div>
           </div>
           <button type="button" class="btn btn-default" onclick='runTracker()'>Run the tracker</button>

           <button type="submit"  class="btn btn-default" onclick="downloadAll(window.downloadLinks , window.rectColor)">download All selected images</button>
         </form>
       </div><!-- /.navbar-collapse -->
     </div><!-- /.container-fluid -->
   </nav>
    <div class="demo-container">
      <!-- width="4476" height="2972" -->
        <canvas id="myCanvas" width="500" height="400" ></canvas>
    </div>
    <script>


// Sticky Note Object
    function StickyNote(downloadLink, xCoordinate, yCoordinate, width, height) {
    this.downloadLink  = downloadLink;
    this.xCoordinate   = xCoordinate;
    this.yCoordinate   = yCoordinate;
    this.width         = width;
    this.height        = height;
  };
        var stickyNotesArray = [];
        var downloadLinks = []; //
        var rectColor = [];
        var registerColorArray = ['magenta', 'cyan', 'yellow' , 'green' ,'orange'];
        var red=0;
        var green=0;
        var blue=0;
        var imageObject = [];
        var imageObj = new Image();
        colorNumber = 0;





// Register new colors
// todo pick colors from image before running
        tracking.ColorTracker.registerColor('orange', function(r, g, b) {
            if (r > 140 && r < 220 && g > 90 && g < 150 && b < 50 ) {
                return true;
            }
            return false;
        });
// Default yellow in tranking.js also detects orange

        tracking.ColorTracker.registerColor('yellow', function(r, g, b) {
          if (r < 255 && r < 200 && g < 200  && g > 200 && b < 50 ) {
              return true;
          }
          return false;
      });

      tracking.ColorTracker.registerColor('green', function(r, g, b) {
        if (r < 140 && g > 150 && b < 50) {
            return true;
        }
            return false;
        });




        registerCustomColor = function(){
             var hexColor = document.getElementById('colorChoice').value;
             red = parseInt(hexColor.substr(1,2), 16);
             green = parseInt(hexColor.substr(3,2), 16);
             blue = parseInt(hexColor.substr(5), 16);

             console.log('r : ' + red + " g: " + green + " b: " + blue);
             var colorNumber = document.getElementById('colorNumber').value ;
            console.log(colorNumber);
             tracking.ColorTracker.registerColor(colorNumber, function(r, g, b ,red , green , blue) {
                 if (r > 140 && r < 220 && g > 90 && g < 150 && b < 50 ) {
                     return true;
                 }
                 return false;
             });


             registerColorArray.push(colorNumber);
             console.log(registerColorArray);
            //  colorNumber = colorNumber + 1;
         };

        // colors to track
        var colors = new tracking.ColorTracker(registerColorArray);
        // set minimum rectangle size
        //todo set from canvas by dragging rectangle on screen
        colors.setMinDimension(365);
        // when registered color is detected this function is called
        colors.on('track', function(event) {
            if (event.data.length === 0) {
                console.log('no colors were detected')
            } else {
                event.data.forEach(function(rect) {
                        // create object
                        var stickyNote = new StickyNote( '' ,rect.x, rect.y, rect.width, rect.height);

                        console.log('Postit coordinates X:' + rect.x + ' Y:' + rect.y + ' H:' + rect.height + ' W:' + rect.width + ' Color:' + rect.color);
                        // put rectangle at tracked color
                        window.plot(rect.x, rect.y, rect.width, rect.height);

                        //Make a small Canvas to copy the sticky note you would like to download
                        var hidden_canv = document.createElement('canvas');
                        hidden_canv.style.display = 'none';
                        document.body.appendChild(hidden_canv);
                        hidden_canv.width = rect.width;
                        hidden_canv.height = rect.height;

                        //Draw the data you want to download to the small hidden canvas
                        var hidden_ctx = hidden_canv.getContext('2d');
                        hidden_ctx.drawImage(
                            myCanvas,
                            rect.x, //Start Clipping
                            rect.y, //Start Clipping
                            rect.width, //Clipping Width
                            rect.height, //Clipping Height
                            0, //Place X
                            0, //Place Y
                            hidden_canv.width, //Place Width
                            hidden_canv.height //Place Height
                        );


                        //Create a download URL for the data
                        var hidden_data = hidden_canv.toDataURL("image/png").replace("image/png", "image/octet-stream");
                        // push data to array for downloadAll()function
                        stickyNote.downloadLink = hidden_data;
                        stickyNotesArray.push(stickyNote);
                        downloadLinks.push(hidden_data);
                        rectColor.push(rect.color);

                });
            }
        });


// Selects the image and draws the image to a canvas.

        var openFile = function(event){
        var input = event.target;
        var reader = new FileReader();
        reader.onload = function(){
          var dataURL = reader.result;
          var canvas = document.getElementById('myCanvas');
          // var demoContainer = document.querySelector('.demo-container');
          var context = canvas.getContext('2d');
          // var imageObj = new Image();
          imageObj.src = dataURL;
          imageObj.onload = function() {
            canvas.height = imageObj.height;
            canvas.width = imageObj.width;
          context.drawImage(imageObj, 0, 0);
          // imageObject.push(imageObj);
          // tracking.track(imageObj, colors);

          console.log(imageObj.height);
          console.log(imageObj.width);
          };
        };
        reader.readAsDataURL(input.files[0]);
        };





        // create/plot the rectangle on cavas
        window.plot = function(x, y, w, h) {
            var rect = document.createElement('div');
            document.querySelector('.demo-container').appendChild(rect);
            rect.classList.add('rect');
            rect.style.border = '10px solid ' + 'red' ;
            rect.style.width = w + 'px';
            rect.style.height = h + 'px';
            rect.style.left = x + 'px';
            rect.style.top = y + 'px';
        };

        // loop trough images save to downloads
        var downloadAll = function(downloadLinks , rectColor){
          for (var i = 0; i < downloadLinks.length; i++) {
            var link = document.createElement('a');
            link.setAttribute('download', rectColor[i] + '.png');
            link.style.display = 'none';
            document.body.appendChild(link);
            link.setAttribute('href', downloadLinks[i]);
            link.click();
          };
        };
        // imageObj , colors
        runTracker = function(){
          stickyNotesArray = [];
          // empty the array if links were inside after runnen previous execution
          downloadLinks = [];
          rectColor = [];
          // console.log(downloadLinks);
          // console.log(rectColor);
          // console.log(colors);
          tracking.track(imageObj, colors);
          console.log(stickyNotesArray);
        }


    </script>
    
</body>

</html>
